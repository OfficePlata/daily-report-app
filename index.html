<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>現場日報アプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* スクロールバーのスタイル（任意） */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        body {
            -webkit-tap-highlight-color: transparent; /* スマホでのタップ時のハイライトを無効化 */
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* 数値入力欄の矢印を非表示にする */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans">
    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-2xl">
        
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-blue-400">現場日報</h1>
            <p class="text-gray-400 mt-2">記録者名で前回の内容を読み込み、日報をBaseに送信できます。</p>
        </header>

        <main id="report-form" class="bg-gray-800 p-6 rounded-2xl shadow-2xl space-y-8">
            
            <!-- 基本情報セクション -->
            <section class="space-y-4">
                <h2 class="text-xl font-semibold text-blue-300 border-b border-gray-700 pb-2">基本情報</h2>
                
                <div>
                    <label for="recorder" class="block mb-2 text-sm font-medium text-gray-300">記録者 (ローカル保存・読み込みのキー)</label>
                    <div class="flex items-center gap-2">
                        <input type="text" id="recorder" placeholder="例：田中 太郎" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        <button id="load-button" class="text-white bg-indigo-600 hover:bg-indigo-700 focus:ring-4 focus:ring-indigo-800 font-medium rounded-lg text-sm px-5 py-2.5 transition-colors duration-200 whitespace-nowrap">読み込み</button>
                    </div>
                </div>

                <div>
                    <label for="record-date" class="block mb-2 text-sm font-medium text-gray-300">記録日</label>
                    <input type="date" id="record-date" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                </div>

                <div>
                    <label for="site-name" class="block mb-2 text-sm font-medium text-gray-300">現場名</label>
                    <input type="text" id="site-name" placeholder="例：〇〇ビル新築工事" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                </div>

                <div>
                    <label for="client" class="block mb-2 text-sm font-medium text-gray-300">発注者</label>
                    <input type="text" id="client" placeholder="例：〇〇株式会社" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                </div>
            </section>

             <!-- 契約・担当者情報セクション -->
            <section class="space-y-4">
                <h2 class="text-xl font-semibold text-blue-300 border-b border-gray-700 pb-2">契約・担当者情報</h2>
                 <div>
                    <label for="supervisor-1" class="block mb-2 text-sm font-medium text-gray-300">総括監督員1</label>
                    <input type="text" id="supervisor-1" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                </div>
                 <div>
                    <label for="chief-supervisor" class="block mb-2 text-sm font-medium text-gray-300">主任監督員</label>
                    <input type="text" id="chief-supervisor" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                </div>
                 <div>
                    <label for="contract-amount" class="block mb-2 text-sm font-medium text-gray-300">契約金額 (円)</label>
                    <input type="number" id="contract-amount" placeholder="1000000" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                </div>
                 <div>
                    <label for="contract-period" class="block mb-2 text-sm font-medium text-gray-300">契約工期</label>
                    <input type="text" id="contract-period" placeholder="2023-01-01 〜 2023-12-31" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                </div>
                 <div>
                    <label for="site-office" class="block mb-2 text-sm font-medium text-gray-300">現場事務所</label>
                    <input type="text" id="site-office" placeholder="〇〇県〇〇市..." class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                </div>
            </section>

            <!-- 進捗・作業内容セクション -->
            <section class="space-y-4">
                <h2 class="text-xl font-semibold text-blue-300 border-b border-gray-700 pb-2">進捗・作業内容</h2>
                <div>
                    <label for="progress-rate" class="block mb-2 text-sm font-medium text-gray-300">進捗率 (%)</label>
                    <input type="number" id="progress-rate" placeholder="50" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                </div>
                <div>
                    <label for="remaining-days" class="block mb-2 text-sm font-medium text-gray-300">残作業日数</label>
                    <input type="number" id="remaining-days" placeholder="20" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="completion-date" class="block mb-2 text-sm font-medium text-gray-300">完成予定</label>
                        <input type="date" id="completion-date" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    </div>
                    <div>
                        <label for="inspection-date" class="block mb-2 text-sm font-medium text-gray-300">検査予定日</label>
                        <input type="date" id="inspection-date" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    </div>
                </div>
                <div>
                    <label for="previous-day-details" class="block mb-2 text-sm font-medium text-gray-300">前日工程内容</label>
                    <textarea id="previous-day-details" rows="3" class="block p-2.5 w-full text-sm text-white bg-gray-700 rounded-lg border border-gray-600 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <div>
                    <label for="work-details" class="block mb-2 text-sm font-medium text-gray-300">作業内容</label>
                    <textarea id="work-details" rows="6" class="block p-2.5 w-full text-sm text-white bg-gray-700 rounded-lg border border-gray-600 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <div>
                    <label for="materials-used" class="block mb-2 text-sm font-medium text-gray-300">使用材料</label>
                    <textarea id="materials-used" rows="3" class="block p-2.5 w-full text-sm text-white bg-gray-700 rounded-lg border border-gray-600 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
            </section>

             <!-- 労務・機械セクション -->
            <section class="space-y-4">
                <h2 class="text-xl font-semibold text-blue-300 border-b border-gray-700 pb-2">労務・機械</h2>
                 <div>
                    <label for="inhouse-labor" class="block mb-2 text-sm font-medium text-gray-300">自社労務</label>
                    <textarea id="inhouse-labor" rows="3" class="block p-2.5 w-full text-sm text-white bg-gray-700 rounded-lg border border-gray-600 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <div>
                    <label for="machinery" class="block mb-2 text-sm font-medium text-gray-300">機械</label>
                    <textarea id="machinery" rows="3" class="block p-2.5 w-full text-sm text-white bg-gray-700 rounded-lg border border-gray-600 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <div>
                    <label for="outsourcing" class="block mb-2 text-sm font-medium text-gray-300">外注</label>
                    <textarea id="outsourcing" rows="3" class="block p-2.5 w-full text-sm text-white bg-gray-700 rounded-lg border border-gray-600 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
            </section>
            
            <!-- 原価セクション -->
            <section class="space-y-4">
                 <h2 class="text-xl font-semibold text-blue-300 border-b border-gray-700 pb-2">原価 (円)</h2>
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                     <div>
                        <label for="material-cost" class="block mb-2 text-sm font-medium text-gray-300">材料費</label>
                        <input type="number" id="material-cost" placeholder="0" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    </div>
                    <div>
                        <label for="labor-cost" class="block mb-2 text-sm font-medium text-gray-300">労務費</label>
                        <input type="number" id="labor-cost" placeholder="0" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    </div>
                    <div>
                        <label for="machinery-cost" class="block mb-2 text-sm font-medium text-gray-300">機械費</label>
                        <input type="number" id="machinery-cost" placeholder="0" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    </div>
                     <div>
                        <label for="outsourcing-cost" class="block mb-2 text-sm font-medium text-gray-300">外注費</label>
                        <input type="number" id="outsourcing-cost" placeholder="0" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    </div>
                    <div>
                        <label for="site-expense" class="block mb-2 text-sm font-medium text-gray-300">現場経費</label>
                        <input type="number" id="site-expense" placeholder="0" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    </div>
                    <div>
                        <label for="total-cost" class="block mb-2 text-sm font-medium text-gray-300">原価合計</label>
                        <input type="number" id="total-cost" placeholder="0" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    </div>
                 </div>
            </section>

            <!-- その他セクション -->
            <section class="space-y-4">
                 <h2 class="text-xl font-semibold text-blue-300 border-b border-gray-700 pb-2">その他</h2>
                 <div>
                    <label for="site-photos" class="block mb-2 text-sm font-medium text-gray-300">状況写真</label>
                    <input type="file" id="site-photos" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 transition-colors duration-200">
                    <p class="mt-1 text-xs text-gray-500">※ファイルはBaseに送信されません。</p>
                </div>
            </section>
            
            <!-- 操作ボタン -->
            <div class="flex flex-col sm:flex-row gap-4 pt-4">
                <button id="save-button" class="w-full text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-800 font-medium rounded-lg text-sm px-5 py-3 text-center transition-colors duration-200 flex items-center justify-center disabled:opacity-50">
                    <span id="save-button-text">保存してBaseに送信</span>
                    <div id="save-spinner" class="loader hidden"></div>
                </button>
                <button id="reset-button" class="w-full text-white bg-gray-600 hover:bg-gray-700 focus:ring-4 focus:outline-none focus:ring-gray-800 font-medium rounded-lg text-sm px-5 py-3 text-center transition-colors duration-200">
                    フォームをリセット
                </button>
            </div>
            
            <!-- ステータスメッセージ -->
            <div id="status-message" class="text-center text-sm font-medium h-5 mt-4"></div>

        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('report-form');
            const saveButton = document.getElementById('save-button');
            const saveButtonText = document.getElementById('save-button-text');
            const saveSpinner = document.getElementById('save-spinner');
            const loadButton = document.getElementById('load-button');
            const resetButton = document.getElementById('reset-button');
            const statusMessage = document.getElementById('status-message');
            const dateInput = document.getElementById('record-date');
            const recorderInput = document.getElementById('recorder');

            const STORAGE_KEY = 'dailyWorkReportData_v5'; // バージョン更新
            const LARK_WEBHOOK_URL = 'https://yjpw4ydvu698.jp.larksuite.com/base/automation/webhook/event/QJHWaPXK6wVAOdhMQOPjkV90pwf';

            // 保存・読み込み対象のフォーム要素IDのリストを更新
            const formElementIds = [
                'record-date', 'site-name', 'client', 'supervisor-1', 'chief-supervisor',
                'contract-amount', 'contract-period', 'site-office',
                'progress-rate', 'remaining-days', 'completion-date', 'inspection-date',
                'previous-day-details', 'work-details', 'materials-used',
                'inhouse-labor', 'machinery', 'outsourcing',
                'material-cost', 'labor-cost', 'machinery-cost', 'outsourcing-cost',
                'site-expense', 'total-cost'
            ];
            const allFormElementIds = ['recorder', ...formElementIds];

            // 今日の日付をYYYY-MM-DD形式で設定する
            const setToday = () => {
                const today = new Date();
                today.setMinutes(today.getMinutes() - today.getTimezoneOffset());
                dateInput.value = today.toISOString().slice(0, 10);
            };

            // 記録者名で最新のデータを読み込む
            const loadData = () => {
                const recorderName = recorderInput.value.trim();
                if (!recorderName) {
                    showStatusMessage('記録者名を入力してください。', 'error');
                    return;
                }

                try {
                    const allData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
                    const recorderReports = allData[recorderName];

                    if (recorderReports && recorderReports.length > 0) {
                        // 日付でソートするのではなく、最新のものをreduceで探し出すように変更
                        const latestReport = recorderReports.reduce((latest, current) => {
                            if (!latest['record-date'] || new Date(current['record-date']) > new Date(latest['record-date'])) {
                                return current;
                            }
                            return latest;
                        }, recorderReports[0]);
                        
                        allFormElementIds.forEach(id => {
                            const element = document.getElementById(id);
                            if (element && latestReport[id] !== undefined) {
                                element.value = latestReport[id];
                            }
                        });
                        setToday(); 
                        showStatusMessage(`${recorderName}さんの前回の内容を読み込みました。`, 'success');
                    } else {
                        showStatusMessage(`${recorderName}さんの保存されたデータはありません。`, 'info');
                    }
                } catch (e) {
                    console.error("データの読み込みに失敗しました:", e);
                    showStatusMessage('読み込みに失敗しました。', 'error');
                }
            };
            
            // フォームの現在のデータを保存し、Webhookで送信する
            const saveData = async () => {
                const recorderName = recorderInput.value.trim();
                if (!recorderName) {
                    showStatusMessage('記録者名を入力してください。保存できません。', 'error');
                    return;
                }

                saveButton.disabled = true;
                saveButtonText.textContent = '送信中...';
                saveSpinner.classList.remove('hidden');

                // Lark Baseのフィールド名に合わせたリクエストボディを作成
                const larkRecord = {
                    "記録者": recorderName,
                    "記録日": document.getElementById('record-date').value,
                    "現場名": document.getElementById('site-name').value,
                    "発注者": document.getElementById('client').value,
                    "総括監督員1": document.getElementById('supervisor-1').value,
                    "主任監督員": document.getElementById('chief-supervisor').value,
                    "契約金額": Number(document.getElementById('contract-amount').value) || 0,
                    "契約工期": document.getElementById('contract-period').value,
                    "現場事務所": document.getElementById('site-office').value,
                    "前日工程内容": document.getElementById('previous-day-details').value,
                    "作業内容": document.getElementById('work-details').value,
                    "進捗率": Number(document.getElementById('progress-rate').value) || 0,
                    "残作業日数": Number(document.getElementById('remaining-days').value) || 0,
                    "完成予定": document.getElementById('completion-date').value,
                    "検査予定日": document.getElementById('inspection-date').value,
                    "使用材料": document.getElementById('materials-used').value,
                    "自社労務": document.getElementById('inhouse-labor').value,
                    "機械": document.getElementById('machinery').value,
                    "外注": document.getElementById('outsourcing').value,
                    "材料費": Number(document.getElementById('material-cost').value) || 0,
                    "労務費": Number(document.getElementById('labor-cost').value) || 0,
                    "機械費": Number(document.getElementById('machinery-cost').value) || 0,
                    "外注費": Number(document.getElementById('outsourcing-cost').value) || 0,
                    "現場経費": Number(document.getElementById('site-expense').value) || 0,
                    "原価合計": Number(document.getElementById('total-cost').value) || 0,
                };

                try {
                    const response = await fetch(LARK_WEBHOOK_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(larkRecord),
                    });

                    if (!response.ok) throw new Error(`サーバーエラー: ${response.status}`);
                    
                    const result = await response.json();
                    if(result.code === 0 && result.msg === "success") {
                        showStatusMessage('Baseへの送信に成功しました！', 'success');
                    } else {
                        throw new Error(result.msg || '不明なエラー');
                    }
                } catch (error) {
                    console.error('Webhook送信エラー:', error);
                    showStatusMessage(`Baseへの送信に失敗: ${error.message}`, 'error');
                } finally {
                    saveButton.disabled = false;
                    saveButtonText.textContent = '保存してBaseに送信';
                    saveSpinner.classList.add('hidden');
                }

                // ローカルストレージに保存
                const currentReport = {};
                allFormElementIds.forEach(id => {
                    currentReport[id] = document.getElementById(id)?.value || '';
                });

                try {
                    const allData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
                    const recorderReports = allData[recorderName] || [];
                    
                    const reportIndex = recorderReports.findIndex(r => r['record-date'] === currentReport['record-date']);
                    if (reportIndex > -1) {
                        recorderReports[reportIndex] = currentReport;
                    } else {
                        recorderReports.push(currentReport);
                    }
                    
                    allData[recorderName] = recorderReports;
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));
                } catch (e) {
                    console.error("ローカル保存に失敗:", e);
                    showStatusMessage('ローカルへの保存に失敗しました。', 'error');
                }
            };

            const resetForm = () => {
                form.reset();
                setToday();
                showStatusMessage('フォームをリセットしました。', 'info');
            };
            
            const showStatusMessage = (message, type) => {
                statusMessage.textContent = message;
                const colors = {
                    success: 'text-green-400',
                    error: 'text-red-400',
                    info: 'text-yellow-400',
                };
                statusMessage.className = `text-center text-sm font-medium h-5 mt-4 ${colors[type] || 'text-gray-400'}`;
                
                setTimeout(() => {
                    statusMessage.textContent = '';
                }, 5000);
            };

            saveButton.addEventListener('click', saveData);
            loadButton.addEventListener('click', loadData);
            resetButton.addEventListener('click', resetForm);

            setToday();
        });
    </script>
</body>
</html>

