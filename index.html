<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>現場日報アプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* スクロールバーのスタイル（任意） */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        body {
            -webkit-tap-highlight-color: transparent; /* スマホでのタップ時のハイライトを無効化 */
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans">
    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-2xl">
        
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-blue-400">現場日報</h1>
            <p class="text-gray-400 mt-2">担当者名を入力して、前回の内容を読み込めます。</p>
        </header>

        <main id="report-form" class="bg-gray-800 p-6 rounded-2xl shadow-2xl space-y-8">
            
            <!-- 基本情報セクション -->
            <section class="space-y-4">
                <h2 class="text-xl font-semibold text-blue-300 border-b border-gray-700 pb-2">基本情報</h2>
                
                <!-- 責任者 -->
                <div>
                    <label for="manager-name" class="block mb-2 text-sm font-medium text-gray-300">現場責任者 (保存・読み込みのキー)</label>
                    <div class="flex items-center gap-2">
                        <input type="text" id="manager-name" placeholder="例：田中 太郎" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        <button id="load-button" class="text-white bg-indigo-600 hover:bg-indigo-700 focus:ring-4 focus:ring-indigo-800 font-medium rounded-lg text-sm px-5 py-2.5 transition-colors duration-200 whitespace-nowrap">読み込み</button>
                    </div>
                </div>

                <!-- 日付 -->
                <div>
                    <label for="report-date" class="block mb-2 text-sm font-medium text-gray-300">日付</label>
                    <input type="date" id="report-date" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                </div>

                <!-- 案件番号 -->
                <div>
                    <label for="project-number" class="block mb-2 text-sm font-medium text-gray-300">案件番号</label>
                    <input type="text" id="project-number" placeholder="例：P2023-001" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                </div>

                <!-- 現場名 -->
                <div>
                    <label for="site-name" class="block mb-2 text-sm font-medium text-gray-300">現場名</label>
                    <input type="text" id="site-name" placeholder="例：〇〇ビル新築工事" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                </div>
                
                <!-- 天候 -->
                <div>
                    <label for="weather" class="block mb-2 text-sm font-medium text-gray-300">天候</label>
                    <select id="weather" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        <option>晴れ</option>
                        <option>曇り</option>
                        <option>雨</option>
                        <option>雪</option>
                        <option>その他</option>
                    </select>
                </div>

                <!-- 作業時間 -->
                <div>
                    <label class="block mb-2 text-sm font-medium text-gray-300">作業時間</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                             <label for="start-time" class="block mb-1 text-xs font-medium text-gray-400">開始</label>
                            <input type="time" id="start-time" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        </div>
                        <div>
                            <label for="end-time" class="block mb-1 text-xs font-medium text-gray-400">終了</label>
                            <input type="time" id="end-time" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        </div>
                    </div>
                </div>
            </section>

            <!-- 作業詳細セクション -->
            <section class="space-y-4">
                <h2 class="text-xl font-semibold text-blue-300 border-b border-gray-700 pb-2">作業詳細</h2>
                <!-- 作業員 -->
                <div>
                    <label for="workers" class="block mb-2 text-sm font-medium text-gray-300">作業員（人員）</label>
                    <textarea id="workers" rows="4" placeholder="一人ずつ改行して入力&#10;例：&#10;鈴木 一郎&#10;佐藤 次郎" class="block p-2.5 w-full text-sm text-white bg-gray-700 rounded-lg border border-gray-600 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>

                <!-- 作業内容 -->
                <div>
                    <label for="work-details" class="block mb-2 text-sm font-medium text-gray-300">作業内容</label>
                    <textarea id="work-details" rows="6" placeholder="本日の具体的な作業内容を記載" class="block p-2.5 w-full text-sm text-white bg-gray-700 rounded-lg border border-gray-600 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                
                <!-- 使用機材 -->
                <div>
                    <label for="equipment" class="block mb-2 text-sm font-medium text-gray-300">使用機材・車両</label>
                    <textarea id="equipment" rows="3" placeholder="例：&#10;バックホウ 1台&#10;2tトラック 2台" class="block p-2.5 w-full text-sm text-white bg-gray-700 rounded-lg border border-gray-600 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
            </section>

            <!-- その他セクション -->
            <section class="space-y-4">
                <h2 class="text-xl font-semibold text-blue-300 border-b border-gray-700 pb-2">その他</h2>
                <!-- 備考 -->
                <div>
                    <label for="remarks" class="block mb-2 text-sm font-medium text-gray-300">備考・特記事項</label>
                    <textarea id="remarks" rows="3" placeholder="ヒヤリハット、資材搬入予定などを記載" class="block p-2.5 w-full text-sm text-white bg-gray-700 rounded-lg border border-gray-600 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>

                <!-- 添付ファイル -->
                <div>
                    <label for="attachments" class="block mb-2 text-sm font-medium text-gray-300">添付ファイル</label>
                    <input type="file" id="attachments" multiple class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 transition-colors duration-200">
                    <p class="mt-1 text-xs text-gray-500">※プロトタイプのためファイルは保存されません。</p>
                </div>
            </section>
            
            <!-- 操作ボタン -->
            <div class="flex flex-col sm:flex-row gap-4 pt-4">
                <button id="save-button" class="w-full text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-800 font-medium rounded-lg text-sm px-5 py-3 text-center transition-colors duration-200">
                    内容を保存する
                </button>
                <button id="reset-button" class="w-full text-white bg-gray-600 hover:bg-gray-700 focus:ring-4 focus:outline-none focus:ring-gray-800 font-medium rounded-lg text-sm px-5 py-3 text-center transition-colors duration-200">
                    フォームをリセット
                </button>
            </div>
            
            <!-- ステータスメッセージ -->
            <div id="status-message" class="text-center text-sm font-medium h-5"></div>

        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('report-form');
            const saveButton = document.getElementById('save-button');
            const loadButton = document.getElementById('load-button');
            const resetButton = document.getElementById('reset-button');
            const statusMessage = document.getElementById('status-message');
            const dateInput = document.getElementById('report-date');
            const managerNameInput = document.getElementById('manager-name');

            const STORAGE_KEY = 'dailyWorkReportData_v3';

            // 保存・読み込み対象のフォーム要素IDのリスト
            const formElementIds = [
                'report-date', 'project-number', 'site-name', 'weather', 'start-time', 'end-time',
                'workers', 'work-details', 'equipment', 'remarks'
            ];
            const allFormElementIds = ['manager-name', ...formElementIds];


            // 今日の日付をYYYY-MM-DD形式で設定する
            const setToday = () => {
                const today = new Date();
                today.setMinutes(today.getMinutes() - today.getTimezoneOffset());
                dateInput.value = today.toISOString().slice(0, 10);
            };

            // 担当者名で最新のデータを読み込む
            const loadManagerData = () => {
                const managerName = managerNameInput.value.trim();
                if (!managerName) {
                    showStatusMessage('現場責任者名を入力してください。', 'error');
                    return;
                }

                try {
                    const allData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
                    const managerReports = allData[managerName];

                    if (managerReports && managerReports.length > 0) {
                        // 日付で降順にソートして最新のものを取得
                        managerReports.sort((a, b) => new Date(b['report-date']) - new Date(a['report-date']));
                        const latestReport = managerReports[0];
                        
                        // フォーム要素に値を設定
                        allFormElementIds.forEach(id => {
                            const element = document.getElementById(id);
                            if (element && latestReport[id] !== undefined) {
                                element.value = latestReport[id];
                            }
                        });
                        setToday(); // 日付は今日に設定
                        showStatusMessage(`${managerName}さんの前回の内容を読み込みました。`, 'success');
                    } else {
                        showStatusMessage(`${managerName}さんの保存されたデータはありません。`, 'info');
                    }
                } catch (e) {
                    console.error("データの読み込みに失敗しました:", e);
                    showStatusMessage('読み込みに失敗しました。', 'error');
                }
            };

            // フォームの現在のデータを担当者別に保存する
            const saveData = () => {
                const managerName = managerNameInput.value.trim();
                if (!managerName) {
                    showStatusMessage('現場責任者名を入力してください。保存できません。', 'error');
                    return;
                }

                const currentReport = {};
                allFormElementIds.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        currentReport[id] = element.value;
                    }
                });

                try {
                    const allData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
                    const managerReports = allData[managerName] || [];
                    
                    // 同じ日付のレポートがあれば更新、なければ追加
                    const reportIndex = managerReports.findIndex(r => r['report-date'] === currentReport['report-date']);
                    if (reportIndex > -1) {
                        managerReports[reportIndex] = currentReport;
                    } else {
                        managerReports.push(currentReport);
                    }
                    
                    allData[managerName] = managerReports;
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));
                    showStatusMessage('入力内容を保存しました。', 'success');
                } catch (e) {
                    console.error("データの保存に失敗しました:", e);
                    showStatusMessage('保存に失敗しました。', 'error');
                }
            };

            // フォームの表示をリセットする
            const resetForm = () => {
                form.reset();
                setToday();
                showStatusMessage('フォームをリセットしました。', 'info');
            };
            
            // ユーザーにフィードバックメッセージを表示する
            const showStatusMessage = (message, type) => {
                statusMessage.textContent = message;
                const colors = {
                    success: 'text-green-400',
                    error: 'text-red-400',
                    info: 'text-yellow-400',
                };
                statusMessage.className = `text-center text-sm font-medium h-5 ${colors[type] || 'text-gray-400'}`;
                
                setTimeout(() => {
                    statusMessage.textContent = '';
                }, 3000);
            };

            // イベントリスナーを設定
            saveButton.addEventListener('click', saveData);
            loadButton.addEventListener('click', loadManagerData);
            resetButton.addEventListener('click', resetForm);

            // 初期化
            setToday();
        });
    </script>
</body>
</html>

